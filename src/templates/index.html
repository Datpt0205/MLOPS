<!doctype html>
<html lang="vi">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">

    <title>MLflow Flask API Demo</title>
    <style>
      /* Thêm style tùy chỉnh nếu cần */
      .status-ok { color: green; font-weight: bold; }
      .status-error { color: red; font-weight: bold; }
      #result {
          background-color: #f8f9fa;
          border: 1px solid #dee2e6;
          padding: 1rem;
          border-radius: 0.25rem;
          min-height: 100px;
          white-space: pre-wrap; /* Giữ định dạng JSON */
          word-wrap: break-word;
      }
      #loading-spinner {
          display: none; /* Ẩn ban đầu */
      }
    </style>
  </head>
  <body>
    <div class="container mt-4">
        <header class="pb-3 mb-4 border-bottom">
            <h1 class="display-5">Dự đoán với Model (từ Artifact)</h1>
        </header>

        <div class="row">
            <div class="col-md-6">
                <div class="card mb-4">
                    <div class="card-header">
                        Thông tin Model
                    </div>
                    <div class="card-body">
                        <p class="card-text"><strong>Model Path Configured:</strong> <code>{{ model_path }}</code></p>
                        <p class="card-text"><strong>Trạng thái model:</strong>
                            {% if model_status == 'OK' %}
                                <span class="status-ok">OK</span>
                            {% else %}
                                <span class="status-error">ERROR</span>
                            {% endif %}
                        </p>
                        {% if error_message %}
                            <div class="alert alert-danger" role="alert">
                                <strong>Lỗi tải model:</strong> {{ error_message }}
                            </div>
                        {% endif %}
                    </div>
                </div>

                <div class="card">
                    <div class="card-header">
                        Nhập liệu
                    </div>
                    <div class="card-body">
                        <form id="predictForm">
                            <div class="mb-3">
                                <label for="features" class="form-label">Nhập {{ n_features }} features (cách nhau bởi dấu phẩy):</label>
                                <input type="text" class="form-control" id="features" name="features" value="{{ ([0.5] * n_features)|join(',') }}" required>
                                <div class="form-text">Ví dụ: 0.1, 0.2, ..., 1.0</div>
                            </div>
                            <button type="button" class="btn btn-primary" onclick="sendPrediction()">
                                <span id="loading-spinner" class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>
                                Dự đoán
                            </button>
                        </form>
                    </div>
                </div>
            </div>

            <div class="col-md-6">
                 <div class="card">
                    <div class="card-header">
                        Kết quả Dự đoán
                    </div>
                    <div class="card-body">
                         <pre id="result">Chưa có kết quả.</pre>
                    </div>
                </div>
            </div>
        </div>

        <footer class="pt-3 mt-4 text-muted border-top">
            MLflow Flask Demo &copy; 2025
        </footer>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>
    <script>
        const predictForm = document.getElementById('predictForm');
        const featuresInput = document.getElementById('features');
        const resultDiv = document.getElementById('result');
        const predictButton = predictForm.querySelector('button');
        const loadingSpinner = document.getElementById('loading-spinner');
        const N_FEATURES = {{ n_features }}; // Lấy số feature từ Flask

        function sendPrediction() {
            const featuresString = featuresInput.value;
            // Tách và chuyển đổi sang số, lọc bỏ giá trị rỗng
            const featuresArray = featuresString.split(',')
                                        .map(s => s.trim()) // Xóa khoảng trắng thừa
                                        .filter(s => s !== "") // Bỏ phần tử rỗng
                                        .map(Number);

            resultDiv.textContent = 'Đang xử lý...';
            predictButton.disabled = true; // Vô hiệu hóa nút khi đang gửi
            loadingSpinner.style.display = 'inline-block'; // Hiện spinner

            // --- Validation cơ bản phía client ---
            if (featuresArray.length !== N_FEATURES) {
                resultDiv.textContent = `Lỗi: Vui lòng nhập đúng ${N_FEATURES} features. Hiện tại có ${featuresArray.length} features.`;
                predictButton.disabled = false;
                loadingSpinner.style.display = 'none';
                return;
            }
            if (featuresArray.some(isNaN)) {
                resultDiv.textContent = 'Lỗi: Vui lòng chỉ nhập các giá trị số.';
                predictButton.disabled = false;
                loadingSpinner.style.display = 'none';
                return;
            }
            // --- Kết thúc Validation ---


            fetch('/predict', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ features: featuresArray })
            })
            .then(response => {
                if (!response.ok) {
                    // Nếu server trả về lỗi (vd: 400, 500, 503)
                    return response.json().then(errData => {
                        // Ném lỗi để catch xử lý chung
                        throw new Error(`Lỗi ${response.status}: ${errData.error || response.statusText}`);
                    });
                }
                return response.json(); // Trả về JSON nếu thành công (200 OK)
            })
            .then(data => {
                // Hiển thị kết quả JSON đã được định dạng
                resultDiv.textContent = JSON.stringify(data, null, 2);
            })
            .catch(error => {
                console.error('Lỗi khi gọi API:', error);
                resultDiv.textContent = 'Lỗi khi gọi API dự đoán: ' + error.message;
            })
            .finally(() => {
                 // Chạy sau khi fetch thành công hoặc thất bại
                 predictButton.disabled = false; // Kích hoạt lại nút
                 loadingSpinner.style.display = 'none'; // Ẩn spinner
            });
        }
    </script>
  </body>
</html>